<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JCU Gym System</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>JCU Gym System</h1>
      <a href="index.html">
        <img src="image/jcu_logo.png">
      </a>
    </header>

    <nav class="nav_user">
      <ul class="menu">
        <li class="menu-choice"><a href="online_registration.html">Online Registration</a></li>
        <li class="menu-choice"><a href="session_booking.html">Session Booking</a></li> 
        <li class="menu-choice"><a href="material.html">Material</a></li>
        <li class="menu-choice"><a href="profile.html">Profile</a></li>
      </ul>
    </nav>

    <hr class="divider" width="1500" color="black" size="3">

    <form id="staffForm" onsubmit="return handleSubmit(event)">
      <main>
        <section class="form-section">
          <h2>GYMNASIUM MEMBERSHIP AND INDEMNITY FORM FOR STAFF</h2>

          <fieldset>
            <legend>1. MEMBERSHIP DETAILS</legend>
            <label>Membership Expiry Date:
              <input type="date" name="expiry_date" id="expiry_date">
            </label><br><br>
            <label>Title:
              <select name="title" id="title">
                <option value="">--Select--</option>
                <option>Mr</option>
                <option>Mrs</option>
                <option>Ms</option>
              </select>
            </label>
            <label>Name &amp; Staff ID:
              <input type="text" name="name_staff_id" id="name_staff_id" style="width: 300px;">
              <button type="button" onclick="searchStaff()">Search</button>
            </label>
          </fieldset>
          <br>

          <fieldset>
            <legend>2. MEMBER DETAILS <small>(renewing member must complete a new form)</small></legend>
            <label>Gender:
              <input type="radio" name="gender" value="male"> Male
              <input type="radio" name="gender" value="female"> Female
            </label><br><br>
            <label>Date Of Birth:
              <input type="date" name="dob" id="dob">
            </label><br><br>
            <label>Telephone:
              <input type="tel" name="telephone" id="telephone"> (Mobile)
            </label><br><br>
            <label>JCU Email:
              <input type="email" name="email" id="email" style="width: 300px;">
            </label><br><br>
            <label>Emergency Contact Name:
              <input type="text" name="emergency_name" id="emergency_name" style="width: 300px;">
            </label><br><br>
            <label>Emergency Contact Number:
              <input type="tel" name="emergency_number" id="emergency_number">
            </label>
          </fieldset>
          <br>

          <fieldset>
            <legend>3. MEMBERâ€™S DECLARATION AND PAYMENT DETAILS</legend>
            <strong>Acknowledgement of Risks, Injury & Obligations</strong>
            <ol>
              <li>
                I hereby acknowledge and am fully aware of the possible risks involved in the use of the
                facilities or premises of the Gymnasium and accept that by participating in such activities
                in the Gymnasium, I am exposed to certain risks.
              </li>
            </ol>
          </fieldset>

          <br>
          <button type="submit">Submit</button>
        </section>
      </main>
    </form>

    <hr class="divider" width="1500" color="black" size="3">

    <footer>
      <div class="contact_info">
        <p>Email: <a href="mailto:jcu.edu.sg">jcu.edu.sg</a></p>
        <p>Phone: <a href="tel:12345678">12345678</a></p>
        <p>Fax: 4779 1244</p>
        <p>Address: 149 Sims Drive Singapore 387380</p>
        <p>&copy; Copyright 2022. ALL Rights Reserved.</p>
      </div>
    </footer>
  </div>

  <script>
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function validateForm() {
      const requiredFields = [
        'expiry_date', 'title', 'name_staff_id',
        'dob', 'telephone', 'email',
        'emergency_name', 'emergency_number'
      ];
      for (let field of requiredFields) {
        if (!document.getElementById(field).value.trim()) {
          alert("Please fill in all fields before submitting.");
          return false;
        }
      }
      if (!document.querySelector('input[name="gender"]:checked')) {
        alert("Please select gender.");
        return false;
      }
      return true;
    }

    function handleSubmit(event) {
  event.preventDefault();
  if (!validateForm()) return;

  const formData = new FormData(document.getElementById('staffForm'));
  const data = new URLSearchParams(formData);

  fetch('/register_staff', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: data.toString()
  })
    .then(res => res.text())
    .then(response => {
      alert("Registration successful!");
      document.getElementById('staffForm').reset();
    })
    .catch(err => {
      console.error(err);
      alert("An error occurred during registration.");
    });

  return false;
}

    function searchStaff() {
      const staffID = document.getElementById('name_staff_id').value.trim();
      if (!staffID) {
        alert("Please enter Name & Staff ID first.");
        return;
      }

      fetch(`/staff_search?name_staff_id=${encodeURIComponent(staffID)}`)
        .then(res => {
          if (!res.ok) throw new Error("Not found");
          return res.json();
        })
        .then(data => {
          document.getElementById('expiry_date').value = data.expiry_date ? formatDate(data.expiry_date) : '';
          document.getElementById('title').value = data.title || '';
          document.querySelector(`input[name="gender"][value="${data.gender}"]`)?.click();
          document.getElementById('dob').value = data.dob ? formatDate(data.dob) : '';
          document.getElementById('telephone').value = data.telephone || '';
          document.getElementById('email').value = data.email || '';
          document.getElementById('emergency_name').value = data.emergency_name || '';
          document.getElementById('emergency_number').value = data.emergency_number || '';
        })
        .catch(() => {
          alert("No staff member found with that Name & Staff ID.");
        });
    }
  </script>
</body>
</html>
