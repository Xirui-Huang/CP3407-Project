<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Bookings</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header>
            <h1>JCU Gym System</h1>
            <a href="index.html">
                <img src="image/jcu_logo.png" alt="JCU Logo">
            </a>
        </header>

        <!-- 导航栏 -->
        <nav class="nav_user">
            <ul class="menu">
                <li class="menu-choice"><a href="monitor.html">Monitor</a></li>
                <li class="menu-choice"><a href="tracking.html">Tracking</a></li>
                <li class="menu-choice"><a href="profile.html">Profile</a></li>
            </ul>
        </nav>


        <hr class="divider">

        <!-- 主体内容 -->
        <main>
            <h2>Booking Monitor</h2>

            <!-- 搜索栏 -->
            <div>
                <label for="searchId">Enter Name & Staff ID: </label>
                <input type="text" id="searchId" placeholder="e.g. JohnDoe123">
                <button onclick="searchBookings()">Search</button>
            </div>

            <br>

            <!-- 查询结果表格 -->
            <table border="1" width="100%">
                <thead>
                    <tr>
                        <th>Booking Reference</th>
                        <th>Name & Staff ID</th>
                        <th>Booking Date</th>
                        <th>Booking Time</th>
                        <th>Booked On</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="bookingTable"></tbody>
            </table>
        </main>

        <hr class="divider">

        <!-- 页脚 -->
        <footer>
            <div class="contact_info">
                <p>Email: <a href="mailto:jcu.edu.sg">jcu.edu.sg</a></p>
                <p>Phone: <a href="tel:12345678">12345678</a></p>
                <p>Fax: 4779 1244</p>
                <p>Address: 149 Sims Drive Singapore 387380</p>
                <p>&copy; Copyright 2022. ALL Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // 访问权限验证
        const role = localStorage.getItem('role');
        if (role !== 'staff') {
            alert("Access denied. Only staff can use this page.");
            window.location.href = "index.html";
        }

        // 搜索预约记录
        function searchBookings() {
            const staffId = document.getElementById('searchId').value.trim();
            if (!staffId) {
                alert("Please enter a Name & Staff ID to search.");
                return;
            }

            fetch(`/get_bookings?name_staff_id=${encodeURIComponent(staffId)}`)
                .then(res => res.json())
                .then(bookings => {
                    const table = document.getElementById('bookingTable');
                    table.innerHTML = "";
                    if (bookings.length === 0) {
                        table.innerHTML = `<tr><td colspan="6">No bookings found.</td></tr>`;
                        return;
                    }
                    bookings.forEach(b => {
                        table.innerHTML += `
                            <tr>
                                <td>${b.booking_ref}</td>
                                <td>${b.name_staff_id}</td>
                                <td>${b.booking_date}</td>
                                <td>${b.booking_time}</td>
                                <td>${b.booked_on}</td>
                                <td><button onclick="deleteBooking('${b.booking_ref}', '${staffId}')">Delete</button></td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error(err);
                    alert("Error retrieving bookings.");
                });
        }

        // 删除预约
        function deleteBooking(bookingRef, staffId) {
            if (!confirm("Are you sure you want to delete this booking?")) return;

            fetch(`/delete_booking?booking_ref=${encodeURIComponent(bookingRef)}`, {
                method: 'DELETE'
            })
            .then(res => res.text())
            .then(msg => {
                alert(msg);
                searchBookings();
            })
            .catch(err => {
                console.error(err);
                alert("Error deleting booking.");
            });
        }
    </script>
</body>
</html>
