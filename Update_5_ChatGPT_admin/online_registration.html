<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JCU Gym System - Register</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>JCU Gym System</h1>
    </header>

    <hr class="divider" width="1500" color="black" size="3">

    <form id="staffForm" onsubmit="return handleSubmit(event)">
      <main>
        <section class="form-section">
          <h2>GYMNASIUM MEMBERSHIP AND INDEMNITY FORM</h2>

          <fieldset>
            <legend>1. MEMBERSHIP DETAILS</legend>

            <label>Membership Expiry Date:
              <input type="date" name="expiry_date" id="expiry_date">
            </label><br><br>

            <!-- Role selection -->
            <label>Role:
              <input type="radio" name="role" value="student" required> Student
              <input type="radio" name="role" value="staff" required> Staff
            </label><br><br>

            <label>Title:
              <select name="title" id="title">
                <option value="">--Select--</option>
                <option>Mr</option>
                <option>Mrs</option>
                <option>Ms</option>
              </select>
            </label>

            <label>Name &amp; Staff ID:
              <input type="text" name="name_staff_id" id="name_staff_id" style="width: 200px;">
              <button type="button" onclick="searchStaff()">Search</button>
            </label>
          </fieldset>
          <br>

          <fieldset>
            <legend>2. MEMBER DETAILS</legend>
            <label>Gender:
              <input type="radio" name="gender" value="male"> Male
              <input type="radio" name="gender" value="female"> Female
            </label><br><br>
            <label>Date Of Birth:
              <input type="date" name="dob" id="dob">
            </label><br><br>
            <label>Telephone:
              <input type="tel" name="telephone" id="telephone"> (Mobile)
            </label><br><br>
            <label>JCU Email:
              <input type="email" name="email" id="email" style="width: 300px;">
            </label><br><br>
            <label>Emergency Contact Name:
              <input type="text" name="emergency_name" id="emergency_name" style="width: 300px;">
            </label><br><br>
            <label>Emergency Contact Number:
              <input type="tel" name="emergency_number" id="emergency_number">
            </label><br><br>
            <label>Password:
              <input type="password" name="password" id="password" style="width: 300px;">
            </label><br><br>
          </fieldset>
          <br>

          <fieldset>
            <legend>3. MEMBER’S DECLARATION</legend>
            <strong>Acknowledgement of Risks, Injury & Obligations</strong>
            <ol>
              <li>
                I hereby acknowledge and am fully aware of the possible risks involved in the use of the
                facilities or premises of the Gymnasium.
              </li>
            </ol>
          </fieldset>

          <br>
          <button type="submit">Submit</button>
        </section>
      </main>
    </form>

    <hr class="divider" width="1500" color="black" size="3">

    <footer>
      <div class="contact_info">
        <p>Email: <a href="mailto:jcu.edu.sg">jcu.edu.sg</a></p>
        <p>Phone: <a href="tel:12345678">12345678</a></p>
        <p>Fax: 4779 1244</p>
        <p>Address: 149 Sims Drive Singapore 387380</p>
        <p>&copy; Copyright 2022. ALL Rights Reserved.</p>
      </div>
    </footer>
  </div>

  <script>
    let canRegister = false;

    function validateForm() {
      const requiredFields = [
        'expiry_date', 'title', 'name_staff_id',
        'dob', 'telephone', 'email',
        'emergency_name', 'emergency_number', 'password'
      ];
      for (let field of requiredFields) {
        if (!document.getElementById(field).value.trim()) {
          alert("Please fill in all fields before submitting.");
          return false;
        }
      }
      if (!document.querySelector('input[name="gender"]:checked')) {
        alert("Please select gender.");
        return false;
      }
      if (!document.querySelector('input[name="role"]:checked')) {
        alert("Please select role.");
        return false;
      }
      return true;
    }

    function searchStaff() {
      const nameStaffId = document.getElementById('name_staff_id').value.trim();
      if (!nameStaffId) {
        alert("Please enter a Name & Staff ID to search.");
        return;
      }

      fetch(`/staff_search?name_staff_id=${encodeURIComponent(nameStaffId)}`)
        .then(res => {
          if (res.status === 404) {
            canRegister = true;
            alert("No existing record found. You can register.");
            // 清空其他字段
            document.getElementById('expiry_date').value = '';
            document.querySelectorAll('input[name="role"]').forEach(r => r.checked = false);
            document.getElementById('title').value = '';
            document.querySelectorAll('input[name="gender"]').forEach(r => r.checked = false);
            document.getElementById('dob').value = '';
            document.getElementById('telephone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('emergency_name').value = '';
            document.getElementById('emergency_number').value = '';
            document.getElementById('password').value = '';
            return null;
          } else {
            return res.json();
          }
        })
        .then(data => {
          if (data) {
            canRegister = false;
            alert("This Name & Staff ID is already registered. Information loaded.");
            // 自动填充表单
            document.getElementById('expiry_date').value = data.expiry_date ? data.expiry_date.split('T')[0] : '';
            if (data.role) {
              document.querySelector(`input[name="role"][value="${data.role}"]`).checked = true;
            }
            document.getElementById('title').value = data.title || '';
            if (data.gender) {
              document.querySelector(`input[name="gender"][value="${data.gender}"]`).checked = true;
            }
            document.getElementById('dob').value = data.dob ? data.dob.split('T')[0] : '';
            document.getElementById('telephone').value = data.telephone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('emergency_name').value = data.emergency_name || '';
            document.getElementById('emergency_number').value = data.emergency_number || '';
            document.getElementById('password').value = data.password || '';
          }
        })
        .catch(err => {
          console.error(err);
          alert("Error searching staff.");
        });
    }

    function handleSubmit(event) {
      event.preventDefault();
      if (!validateForm()) return;

      const formData = new FormData(document.getElementById('staffForm'));
      const data = new URLSearchParams(formData);
      const role = formData.get('role');

      fetch('/register_staff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: data.toString()
      })
        .then(res => res.text())
        .then(response => {
          alert("Registration successful!");
          const name_staff_id = document.getElementById('name_staff_id').value.trim();
          localStorage.setItem('name_staff_id', name_staff_id);
          localStorage.setItem('role', role);

          if (role === 'student') {
            window.location.href = 'session_booking.html';
          } else {
            window.location.href = 'monitor.html';
          }
        })
        .catch(err => {
          console.error(err);
          alert("An error occurred during registration.");
        });

      return false;
    }
  </script>
</body>
</html>
